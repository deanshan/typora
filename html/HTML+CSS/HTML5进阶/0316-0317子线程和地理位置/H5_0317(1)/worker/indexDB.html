<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>本地</title>
	</head>
	<body>
		<div class="form">
			<h3>用户注册</h3>
			姓名：<input type="text" id="name" value="anliny" placeholder="请输入用户名" /></br>
			年龄：<input type="number" id="age" value="25" placeholder="请输入年龄" /></br>
			邮箱：<input type="email" id="email" value="anliny@youtube.com" placeholder="请输入邮箱" /></br>
			
			<input type="hidden" value="" id="userid" />
			<button id="sbt">提交</button>
			<button id="updata" >修改</button>
			</br></br>
		</div>
		
		<div>
			<h3>查询用户</h3>
			姓名：<input type="text" id="searchName" value="anliny" placeholder="请输入用户名" />
			<button id="search">查询</button>
		</div>
		
		<div>
			<h3>用户列表</h3>
			<table id="table" border="1" rows="0" cols="0"></table>
		</div>
		<script type="text/javascript">
			var sbt  = document.querySelector("#sbt");
			var username = document.querySelector("#name");
			var age = document.querySelector("#age");
			var email = document.querySelector("#email");
			var table = document.querySelector("#table");
			var updata = document.querySelector("#updata");
			var userid = document.querySelector("#userid");
			
//			var indexdb ={};
			function createOrOpen(){
				var dataBaseInfo = {
					databaseName : "htmlClass",
					version : 1,
				}
				
				//htmlClass   //数据库的名称
				// 1         数据库的版本号 ()
				var dataBase = indexedDB.open(dataBaseInfo.databaseName,dataBaseInfo.version);
				
				//第一打开或者版本更新
				dataBase.onupgradeneeded = function (req){
					indexdb = req.target.result;
					
					//创建一个存储空间，  也就是表
					var objStore = indexdb.createObjectStore("userInfo",{
						//表唯一的标识，ID
						keyPath:"id",
						//自动生成数字键。
						autoIncrement:true
					});
				}
				
				//创建或者打开失败  
				dataBase.onerror = function(rsq){
					alert("创建或者打开数据库失败 ");
				}
				//创建成功 
				dataBase.onsuccess = function(req){
					indexdb = req.target.result;
					
					getAll();
					console.log("创建或者打开数据库成功");
				}
			}
			
			//点击提交   
			sbt.onclick = addOrUpdate;
			//修改的方法
			updata.onclick = addOrUpdate;
			
			
			function addOrUpdate(){
				var user = {
					id: !userid.value ? +new Date() : Number(userid.value),
					name:username.value,
					age:age.value,
					email:email.value
				}
				console.log(user);
				//在数据库里面创建一个叫做  “userInfo”的  这个表设置 可读写
				var transaction = indexdb.transaction(["userInfo"], "readwrite");
				
				//此索引引用对象存储的名称
				var dbStore = transaction.objectStore("userInfo");
				//把数据写入到  userInfo 表中  如果用这条数据  就表示更新， 否则表示  写入
				var addUser = dbStore.put(user);
				addUser.onsuccess = function(req){
					username.value="";
					age.value="";
					email.value="";
					userid.value = "";
					getAll();
					console.log(req);
				}
				addUser.onerror = function(req){
					console.log(req);
				}
			}
			
			//查询所有的数据 
			function getAll(){
				var userAll =  indexdb.transaction(["userInfo"], "readwrite")
				.objectStore("userInfo")
				.getAll();
				userAll.onsuccess = function(req){
					var userList = req.target.result;
					var tr = "";
					var tr="";
					tr +=	'<thead>'+
								'<tr>'+
									'<th>id</th>'+
									'<th>姓名</th>'+
									'<th>年龄</th>'+
									'<th>邮箱</th>'+
									'<th>操作</th>'+
								'</tr>'+
							'</thead>'+
							'<tbody>';
					for (var i=0;i<userList.length;i++) {
						tr += '<tr>'+
								'<td>'+userList[i].id+'</td>'+
								'<td>'+userList[i].name+'</td>'+
								'<td>'+userList[i].age+'</td>'+
								'<td>'+userList[i].email+'</td>'+
								'<td><a href="javascript:;" onClick="removeUser(\''+userList[i].id+'\')">删除</a>|<a href="javascript:;" onClick="updataUser(\''+userList[i].id+'\')">修改</a></td>'+
							  '</tr>'
					}		
					table.innerHTML = tr;		
				}
				userAll.onerror = function(req){
					console.log(req);
				}
			}
			
			//删除一条数据
			function removeUser(id){
				var deleUser = indexdb.transaction(["userInfo"], "readwrite")
				.objectStore("userInfo")
				.delete(Number(id));
				
				deleUser.onsuccess = function(rsq){
					getAll();
					alert("删除成功！")
				}
				
				deleUser.onerror = function(req){
					console.log(req);
				}
			}
			
			//修改一条数据
			function updataUser(id){
				//先查询本条数据
				var getUser = indexdb.transaction(["userInfo"], "readwrite")
				.objectStore("userInfo")
				.get(Number(id));
				
				getUser.onsuccess = function(rsq){
					var data = rsq.target.result;
					username.value = data.name;
					age.value = data.age;
					email.value = data.email;
					userid.value = data.id;
				}
				
				getUser.onerror = function(req){
					console.log(req);
				}
				
			}
			
			
			
			
			window.onload = function (){
				createOrOpen();
			}
			
		</script>
	</body>
</html>
